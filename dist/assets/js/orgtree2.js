document.addEventListener("DOMContentLoaded",(async()=>{document.getElementById("workarea").classList.add("flex","h-screen","mt-4");const e=document.getElementById("org-chart");e.classList.add("w-1/3","bg-white","overflow-y-auto","mr-4","h-5/6");const t=document.getElementById("permissions");t.classList.add("w-2/3","bg-gray-50","p-4","overflow-y-auto","border-t","border-gray-300","border-l","border-gray-300","border-r","border-gray-300","border-b","border-gray-300","h-5/6");const n=document.createElement("h1");n.id="permissions-title",n.style.fontSize="1.1rem",n.style.marginBottom="1.1rem",t.appendChild(n);let o=null,a="",l=[],r=[];async function s(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ${e}`);return await t.json()}function d(){const e=localStorage.getItem("permissionsData");return e?JSON.parse(e):{}}function i(e,r=[],s=0){const c=document.createElement("div");c.style.marginLeft=20*s+"px",c.style.padding="5px",c.style.border="1px solid #ccc",c.style.marginBottom="8px",c.style.cursor="pointer",c.style.display="flex",c.style.alignItems="center";const m=document.createElement("span");m.innerHTML=r.length>0?"+":"",m.style.fontSize="38px",m.style.marginRight="12px",m.style.cursor="pointer",m.style.color="#555",m.style.fontWeight="800",m.style.transform="scaleX(1.2)";const p=document.createElement("span");p.textContent=e;const y=document.createElement("div");return y.style.display="none",y.style.marginLeft="20px",m.addEventListener("click",(e=>{e.stopPropagation(),"none"===y.style.display?(y.style.display="block",m.innerHTML="-"):(y.style.display="none",m.innerHTML="+")})),c.appendChild(m),c.appendChild(p),c.appendChild(y),r.forEach((e=>{const t=i(e.name,e.children||[],s+1);y.appendChild(t)})),p.addEventListener("click",(()=>{o&&(o.style.backgroundColor="",o.style.color=""),c.style.backgroundColor="#0058a3",c.style.color="#ffcc00",c.style.fontWeight="600",o=c,a=e,function(e){n.textContent=`권한 설정: ${e}`}(e),function(e){t.innerHTML="",t.appendChild(n);const o=d()[e]||{},a=document.createElement("div");if(a.id="permissions-container",!l||0===l.length)return void console.error("Permissions data is empty or undefined.");l.forEach((t=>{const n=document.createElement("div");n.style.marginBottom="1rem";const l=document.createElement("h2");l.textContent=t.name,l.style.fontSize="1.0rem",l.style.marginBottom="0.5rem";const r=document.createElement("div");r.style.display="flex",r.style.gap="1rem",t.actions.forEach((n=>{const a=document.createElement("div"),l=document.createElement("input");l.type="checkbox",l.checked=o[t.name]?.includes(n)||!1,l.addEventListener("change",(()=>function(e,t,n,o){let a=d();a[e]||(a[e]={});a[e][t]||(a[e][t]=[]);o?a[e][t].includes(n)||a[e][t].push(n):a[e][t]=a[e][t].filter((e=>e!==n));l=a,localStorage.setItem("permissionsData",JSON.stringify(l));var l}(e,t.name,n,l.checked)));const s=document.createElement("label");s.textContent=n,a.appendChild(l),a.appendChild(s),r.appendChild(a)})),n.appendChild(l),n.appendChild(r),a.appendChild(n)})),t.appendChild(a)}(e)})),c}function c(t){e.innerHTML="";const n=document.createElement("button");n.textContent="전체 펼침",n.style.marginBottom="10px",n.style.backgroundColor="#0058a3",n.style.color="#fff",createTooltip(n,"조직도를 전체 펼쳐서 볼 수 있습니다.");const o=document.createElement("button");o.textContent="조직 수정",o.style.backgroundColor="#333",o.style.color="#fff",o.style.marginRight="10px",o.addEventListener("click",p),createTooltip(o,"조직도를 팝업으로 수정할 수 있습니다.");let a=!1;n.addEventListener("click",(()=>{n.disabled=!0,n.style.backgroundColor="#999",n.style.color="#fff",n.style.cursor="not-allowed",document.querySelectorAll("#org-chart div div").forEach((e=>{e.style.display=a?"none":"block"})),document.querySelectorAll("#org-chart span:first-child").forEach((e=>{e.innerHTML=a?"+":"-",e.style.fontSize="35px",e.style.marginRight="12px",e.style.cursor="pointer",e.style.color="#333",e.style.fontWeight="700",e.style.transform="scaleX(1.2)",e.style.transform="scaleY(1.2)"})),a=!a})),e.appendChild(o),e.appendChild(n),t.forEach((t=>{const n=i(t.name,t.departments.map((e=>({name:e.name,children:e.teams.map((e=>({name:e})))}))));e.appendChild(n)}))}function m(e,t){localStorage.setItem(e,JSON.stringify(t))}function p(){let e=document.getElementById("org-editor-modal");if(!e){e=document.createElement("div"),e.id="org-editor-modal",e.style.position="absolute",e.style.top="14%",e.style.right="2%",e.style.width="70%",e.style.height="60%",e.style.backgroundColor="#fff",e.style.padding="5px",e.style.boxShadow="2px 4px 6px rgba(0, 0, 0, 0.6)",e.style.zIndex="50",e.style.overflow="auto";const n=document.createElement("button");n.textContent="X",n.style.fontWeight="900",n.style.position="absolute",n.style.bottom="10px",n.style.right="10px",n.onclick=()=>{m("organizationData",r),c(r),e.remove()};const o=document.createElement("div");o.style.height="90%",o.style.width="100%",o.id="org-grid",e.appendChild(n),e.appendChild(o),t.appendChild(e);const a={columnDefs:[{field:"name",headerName:"본부",editable:!0,width:"150"},{field:"departments",headerName:"부서",editable:!0,width:"300",valueGetter:e=>e.data.departments.map((e=>e.name)).join(","),valueSetter:e=>{const t=e.newValue.split(",").map(((t,n)=>e.data.departments[n]?{...e.data.departments[n],name:t}:{name:t,teams:[]}));return e.data.departments=t,!0}},{field:"teams",headerName:"팀(부서구분 ; )",editable:!0,width:"700",valueGetter:e=>e.data.departments.map((e=>e.teams.join(","))).join(";"),valueSetter:e=>(e.data.departments.forEach(((t,n)=>{e.newValue.split(";")[n]&&(t.teams=e.newValue.split(";")[n].split(","))})),!0)}],rowData:r,defaultColDef:{editable:!0,cellStyle:{fontSize:"1rem",fontFamily:"'Pretendard', sans-serif"}},domLayout:"autoHeight",onCellValueChanged:e=>{m("organizationData",r)}};new agGrid.createGrid(o,a)}}try{r=function(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null}("organizationData")||await s("assets/mock/org.json"),m("organizationData",r),c(r),l=await s("assets/mock/per.json")}catch(e){console.error("Error loading data:",e)}}));