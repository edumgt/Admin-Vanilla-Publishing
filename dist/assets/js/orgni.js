const workarea=document.getElementById("workarea");workarea.classList.add("grid-container","mt-4");const canvas=document.getElementById("orgChartCanvas"),ctx=canvas.getContext("2d"),canvasWidth=canvas.width;let offsetX,offsetY,draggedNode=null;const orgDataKey="orgData";let savedOrgData=JSON.parse(localStorage.getItem("orgData"));function drawOrgChart(e,t){drawCard(e,t),t.children&&t.children.length>0&&t.children.forEach((a=>{e.beginPath(),e.moveTo(t.x+100,t.y+120),e.bezierCurveTo(t.x+100,t.y+170,a.x+100,a.y-50,a.x+100,a.y),e.strokeStyle="#FFA500",e.lineWidth=2,e.stroke(),drawOrgChart(e,a)}))}function drawCard(e,t){const a=200,n=120,d=10;e.shadowColor="rgba(0, 0, 0, 0.2)",e.shadowBlur=10,e.shadowOffsetX=5,e.shadowOffsetY=5,e.fillStyle="#fff",e.beginPath(),e.moveTo(t.x+d,t.y),e.lineTo(t.x+a-d,t.y),e.quadraticCurveTo(t.x+a,t.y,t.x+a,t.y+d),e.lineTo(t.x+a,t.y+n-d),e.quadraticCurveTo(t.x+a,t.y+n,t.x+a-d,t.y+n),e.lineTo(t.x+d,t.y+n),e.quadraticCurveTo(t.x,t.y+n,t.x,t.y+n-d),e.lineTo(t.x,t.y+d),e.quadraticCurveTo(t.x,t.y,t.x+d,t.y),e.closePath(),e.fill(),e.fillStyle="#0058a3",e.fillRect(t.x,t.y,a,40),e.fillStyle="#f7d117",e.fillRect(t.x,t.y+40,a,40),e.fillStyle="#fff",e.fillRect(t.x,t.y+80,a,40),e.shadowColor="transparent",e.fillStyle="#fff",e.font="15px Noto Sans",e.textAlign="center",e.fillText(t.manager,t.x+100,t.y+22),e.fillStyle="#000",e.fillText(t.name,t.x+100,t.y+60),"CEO"!==t.manager&&(e.fillStyle="#000",e.fillText("x",t.x+a-20,t.y+n-10)),e.fillStyle="#333",e.fillRect(t.x+10,t.y+n-30,100,20),e.fillStyle="#fff",e.fillText("í•˜ìœ„ë¶€ì„œìƒì„±",t.x+60,t.y+n-12),e.fillStyle="#000",e.beginPath(),e.arc(t.x+130,t.y+n-20,10,0,2*Math.PI),e.fill(),e.fillStyle="#fff",e.font="15px Arial",e.fillText("ğŸ”",t.x+130,t.y+n-15)}function findNode(e,t,a){if(t>=e.x&&t<=e.x+200&&a>=e.y&&a<=e.y+120)return e;if(e.children)for(let n=0;n<e.children.length;n++){const d=findNode(e.children[n],t,a);if(d)return d}return null}function findParentNode(e,t,a=null){if(e===t)return a;if(e.children)for(let a=0;a<e.children.length;a++){const n=findParentNode(e.children[a],t,e);if(n)return n}return null}function redraw(){ctx.clearRect(0,0,canvas.width,canvas.height),drawOrgChart(ctx,savedOrgData)}function saveData(){localStorage.setItem("orgData",JSON.stringify(savedOrgData))}function deleteNode(e,t){if(e.children)for(let a=0;a<e.children.length;a++){if(e.children[a]===t)return e.children.splice(a,1),!0;if(deleteNode(e.children[a],t))return!0}return!1}function showModal(e,t,a){const n=document.createElement("div");n.style.position="absolute",n.style.left=`${t}px`,n.style.top=`${a}px`,n.style.backgroundColor="#fff",n.style.padding="20px",n.style.border="1px solid #ccc",n.style.zIndex=1e3,n.innerHTML=`\n        <h2>${e.name}</h2>\n        <p><strong>ë¶€ì„œì¥:</strong> ${e.manager}</p>\n        <p><strong>ë¶€ì„œì¸ì›:</strong> ${e.members||"N/A"}</p>\n        <p><strong>ë¶€ì„œì„¤ëª…:</strong> ${e.description||"N/A"}</p>\n        <div id="map" class="a-map">ì§€ë„ í‘œì‹œ</div>\n        <button type="button" id="closeModal">ë‹«ê¸°</button>\n    `,document.body.appendChild(n),document.getElementById("closeModal").addEventListener("click",(()=>{document.body.removeChild(n)}))}savedOrgData?(savedOrgData.x=canvasWidth/2,savedOrgData.y=0,redraw()):fetch("assets/mock/organi.json").then((e=>e.json())).then((e=>{savedOrgData=e,savedOrgData.x=canvasWidth/2,savedOrgData.y=0,localStorage.setItem("orgData",JSON.stringify(savedOrgData)),redraw()})).catch((e=>console.error("Error fetching the organizational data:",e))),canvas.addEventListener("dblclick",(e=>{const t=canvas.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top,d=findNode(savedOrgData,a,n);if(d){const e=200;if(n>=d.y&&n<=d.y+40){const a=document.createElement("input");a.type="text",a.value=d.manager,a.style.position="absolute",a.style.left=t.left+d.x+e/2-50+"px",a.style.top=`${t.top+d.y+5}px`,a.style.width="200px",document.body.appendChild(a),a.focus(),a.addEventListener("blur",(()=>{d.manager=a.value,document.body.removeChild(a),redraw(),saveData()})),a.addEventListener("keydown",(e=>{"Enter"===e.key&&a.blur()}))}else if(n>d.y+40&&n<=d.y+80){const a=document.createElement("input");a.type="text",a.value=d.name,a.style.position="absolute",a.style.left=t.left+d.x+e/2-50+"px",a.style.top=`${t.top+d.y+45}px`,a.style.width="200px",document.body.appendChild(a),a.focus(),a.addEventListener("blur",(()=>{d.name=a.value,document.body.removeChild(a),redraw(),saveData()})),a.addEventListener("keydown",(e=>{"Enter"===e.key&&a.blur()}))}}})),canvas.addEventListener("mousedown",(e=>{const t=canvas.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top;draggedNode=findNode(savedOrgData,a,n),draggedNode&&"CEO"===draggedNode.manager&&(draggedNode=null),draggedNode&&(offsetX=a-draggedNode.x,offsetY=n-draggedNode.y)})),canvas.addEventListener("mousemove",(e=>{if(draggedNode){const t=canvas.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top;draggedNode.x=a-offsetX,draggedNode.y=n-offsetY,redraw()}})),canvas.addEventListener("mouseup",(()=>{draggedNode&&saveData(),draggedNode=null})),canvas.addEventListener("click",(e=>{const t=canvas.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top,d=findNode(savedOrgData,a,n);if(d){const e=200,l=120,r=d.x+e-20,o=d.y+l-10,i=d.x+10,s=i+100,c=d.y+l-30,f=c+20;if("CEO"!==d.manager&&a>=r-10&&a<=r+10&&n>=o-10&&n<=o+10){const e=findParentNode(savedOrgData,d);e&&(deleteNode(e,d),redraw(),saveData())}if(a>=i&&a<=s&&n>=c&&n<=f){const e={name:"ë¶€ì„œ: ë”ë¸”í´ë¦­ ìˆ˜ì •",manager:"ë§¤ë‹ˆì €: ë”ë¸”í´ë¦­ ìˆ˜ì •",x:d.x+50,y:d.y+150,children:[]};d.children||(d.children=[]),d.children.push(e),redraw(),saveData()}a>=d.x+130&&a<=d.x+150&&n>=d.y+l-30&&n<=d.y+l-10&&showModal(d,t.left+d.x+140,t.top+d.y+l-20)}}));