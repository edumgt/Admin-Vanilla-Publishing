import{createSaveButton}from"./common.js";const saveButton=createSaveButton();document.getElementById("btnContainer").appendChild(saveButton);const workarea=document.getElementById("workarea");workarea.classList.add("flex","w-full","mt-4");const statusBoxes=[{status:"inProgress",label:"In Progress",className:"inProgress",bgColor:"#3b82f6"},{status:"pending",label:"Pending",className:"pending",bgColor:"#fbbf24"},{status:"risk",label:"Risk",className:"risk",bgColor:"#ef4444"},{status:"success",label:"Success",className:"success",bgColor:"#10b981"},{status:"fail",label:"Fail",className:"fail",bgColor:"#6b7280"}];function fetchConsultations(){return JSON.parse(localStorage.getItem("consultations"))||[]}async function fetchConsultants(){try{const t=await fetch("/api/members");if(!t.ok)throw new Error("Failed to fetch employees");const e=(await t.json()).filter((t=>"Consulting"===t.team));return localStorage.setItem("consultants",JSON.stringify(e)),e}catch(t){return console.error("Error fetching consultants:",t),[]}}function saveConsultations(t){localStorage.setItem("consultations",JSON.stringify(t))}function addConsultation(t,e,n){const s=fetchConsultations(),a={id:s.length?s[s.length-1].id+1:1,customerName:t,date:(new Date).toISOString().split("T")[0],log:e,solution:n,status:"pending",consultant:null,reasons:{}};s.push(a),saveConsultations(s),renderProcessFlow()}let selectedStatusBox=null,selectedConsultationId=null,selectedStatus=null;export function openModal(t,e,n){selectedStatusBox=t,selectedConsultationId=e,selectedStatus=n,document.getElementById("modalReason").style.display="flex"}window.openModal=openModal;export function closeModal(){selectedStatusBox=null,selectedConsultationId=null,selectedStatus=null,document.getElementById("modalReason").style.display="none",document.getElementById("reasonInput").value=""}function saveReason(){const t=document.getElementById("reasonInput").value.trim();if(t&&selectedStatusBox&&selectedConsultationId&&selectedStatus){const e=fetchConsultations(),n=e.find((t=>t.id==selectedConsultationId));n.reasons||(n.reasons={});const s=(new Date).toISOString();n.reasons[selectedStatus]={text:t,date:s},selectedStatusBox.style.backgroundColor=statusBoxes.find((t=>t.status===selectedStatus)).bgColor,selectedStatusBox.style.color="white",selectedStatusBox.querySelector("div").innerHTML=`\n            ${t.length>10?t.substring(0,10)+"...":t}\n            <small>${new Date(s).toLocaleString()}</small>\n        `,selectedStatusBox.setAttribute("data-tooltip",t),saveConsultations(e),closeModal()}}function sortConsultations(t,e){return t.sort(((t,n)=>"customerName"===e?t.customerName.localeCompare(n.customerName):"date"===e?new Date(t.date)-new Date(n.date):"consultant"===e?t.consultant&&n.consultant?t.consultant.name.localeCompare(n.consultant.name):t.consultant?-1:n.consultant?1:0:void 0))}function renderProcessFlow(){const t=document.getElementById("sortOptions").value;let e=fetchConsultations();e=sortConsultations(e,t);const n=document.getElementById("processFlow");n.classList.add("mt-2","flex","flex-wrap"),n.innerHTML="",e.forEach((t=>{t.reasons||(t.reasons={});const e=statusBoxes.map((e=>{const n=t.reasons[e.status];return`\n                <div class="status-box ${e.className}" \n                     onclick="openModal(this, ${t.id}, '${e.status}')" \n                     style="background-color: ${n&&n.text?e.bgColor:"transparent"}; \n                            color: ${n&&n.text?"white":"black"};">\n                    <div>\n                        ${n&&n.text?n.text.length>10?n.text.substring(0,10)+"...":n.text:e.label}\n                        ${n&&n.text?`<small>${new Date(n.date).toLocaleString()}</small>`:""}\n                    </div>\n                    ${n&&n.text?`<span class="tooltip">${n.text}</span>`:""}\n                </div>\n            `})).join(""),s=document.createElement("div");s.className="border-t border-gray-100 process-item bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4 w-full flex",s.innerHTML=`\n            <div class="w-2/3 flex items-center droppable" data-id="${t.id}">\n                <div class="bg-blue-500 text-white rounded-full h-8 w-8 flex items-center justify-center mr-4">\n                    ${t.id}\n                </div>\n                <div>\n                    <p class="text-gray-700 text-base"><strong>고객명: </strong> ${t.customerName}</p>\n                    <p class="text-gray-700 text-base"><strong>상담일: </strong> ${t.date}</p>\n                    <p class="text-gray-700 text-base"><strong>상담내용: </strong> ${t.log}</p>\n                    <p class="text-gray-700 text-base"><strong>제안사항: </strong> ${t.solution}</p>\n                    ${t.consultant?`<p class="text-gray-700 text-base"><strong>Consultant:</strong> ${t.consultant.name}</p>`:""}\n                </div>\n            </div>\n            <div class="w-1/3 flex flex-wrap">\n                ${e}\n            </div>\n        `,n.appendChild(s)}));document.querySelectorAll(".droppable").forEach((t=>{t.addEventListener("dragover",(t=>t.preventDefault())),t.addEventListener("drop",handleDrop)}))}async function renderConsultants(){let t=JSON.parse(localStorage.getItem("consultants"));t||(t=await fetchConsultants());const e=document.getElementById("consultantList");e.classList.add("bg-gray-200","p-4","overflow-x-auto","flex","flex-wrap"),e.innerHTML="",t.forEach((t=>{const n=document.createElement("div");n.className="consultant-item bg-white shadow-md rounded-full p-2 m-2 draggable text-center",n.draggable=!0,n.dataset.id=t.id,n.innerHTML=`\n            <p class="text-gray-700 text-sm font-bold">${t.name}</p>\n            <p class="text-gray-500 text-xs">${t.address}</p>\n            <p class="text-gray-500 text-xs">${t.id}</p>\n        `,n.addEventListener("dragstart",handleDragStart),e.appendChild(n)}))}function handleDragStart(t){t.dataTransfer.setData("text/plain",t.target.dataset.id)}function handleDrop(t){const e=t.dataTransfer.getData("text/plain"),n=t.currentTarget.dataset.id;let s=JSON.parse(localStorage.getItem("consultants"));const a=fetchConsultations(),o=s.find((t=>t.id==e)),l=a.find((t=>t.id==n));o&&l&&(l.consultant=o,l.status="inProgress",saveConsultations(a)),renderProcessFlow()}window.closeModal=closeModal,window.saveReason=saveReason,document.getElementById("consultationForm").addEventListener("submit",(function(t){t.preventDefault();addConsultation(document.getElementById("customerName").value,document.getElementById("log").value,document.getElementById("solution").value),this.reset()})),createModal2("modalReason","상태별 메모",'<textarea id="reasonInput" class="appearance-none border rounded w-full h-full py-2 px-3 text-gray-700"\n    placeholder="상태에 대한 내역을 입력하세요"></textarea>',[{label:"저장",class:"bg-blue-500 text-white ",onClick:"saveReason()"},{label:"닫기",class:"bg-gray-500 text-white ",onClick:"closeModal()"}]),document.getElementById("sortOptions").addEventListener("change",renderProcessFlow),document.addEventListener("DOMContentLoaded",(()=>{renderConsultants(),renderProcessFlow()})),document.getElementById("searchButton").addEventListener("click",(t=>{t.preventDefault(),t.stopPropagation();const e=document.getElementById("searchModal");e.style.top="20px",e.style.left="200px",e.style.width="250px",e.classList.remove("hidden"),document.getElementById("searchInput").focus()}));const searchModal=document.getElementById("searchModal");searchModal.classList.add("absolute","bg-white","border","rounded","shadow-lg","hidden","z-50","p-4"),searchModal.innerHTML='\n        <h2 class="text-lg font-semibold mb-2">예약자 찾기</h2>\n            <input type="text" id="searchInput" class="w-full p-2 border rounded mb-2" placeholder="이름 검색"\n                autocomplete="off">\n                <div id="searchResults" class="border rounded p-2 bg-white max-h-48 overflow-y-auto mb-4"></div>\n                <button id="closeModal" class="bg-gray-500 text-white">닫기</button>',document.getElementById("closeModal").addEventListener("click",(()=>{document.getElementById("searchModal").classList.add("hidden")})),document.getElementById("searchInput").addEventListener("input",(async()=>{const t=document.getElementById("searchResults"),e=document.getElementById("searchInput").value.trim().toLowerCase();if(t.innerHTML="",e)try{const n=await fetch("/api/reservations"),s=await n.json();if(console.log(s),!s)return void console.error("JSON 데이터 구조가 올바르지 않습니다.");const a=s.filter((t=>t.name.toLowerCase().includes(e)));a.length>0?a.forEach((e=>{const n=document.createElement("div");n.classList.add("p-2","cursor-pointer","hover:bg-gray-200"),n.textContent=e.name,n.setAttribute("data-name",e.name),t.appendChild(n)})):t.innerHTML='<div class="p-2 text-gray-500">검색 결과 없음</div>'}catch(t){console.error("검색 중 오류 발생:",t)}})),document.getElementById("searchResults").addEventListener("click",(t=>{const e=t.target.getAttribute("data-name");e&&(document.getElementById("customerName").value=e,document.getElementById("searchModal").classList.add("hidden"))})),document.addEventListener("click",(t=>{const e=document.getElementById("searchModal"),n=document.getElementById("searchButton"),s=document.getElementById("customerName");e.contains(t.target)||t.target===n||t.target===s||e.classList.add("hidden")}));