import{createSaveButton}from"./common.js";const calendar=(()=>{const e=document.getElementById("calendar");let t=new Date,n=t.getMonth(),a=t.getFullYear(),c={},r={};const o=async()=>{try{for(const[e,t]of Object.entries(r)){const n=await d(e);for(const e of t){const[t,a,c]=e.split(" - ");await s(n,t,a,c)}}r={},showToast("well-done","success",lang)}catch(e){console.error("Error saving tasks:",e)}},d=async e=>{try{const t=await fetch("/api/addDate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date:e})});if(!t.ok)throw new Error(`Failed to add date: ${t.statusText}`);return(await t.json()).dateId}catch(e){throw console.error("Error adding date:",e),e}},s=async(e,t,n,a)=>{try{const c=await fetch("/api/addEvent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date_id:e,time:t,description:n,event_id:a})});if(!c.ok)throw new Error(`Failed to add event: ${c.statusText}`);return(await c.json()).eventId}catch(e){throw console.error("Error adding event:",e),e}},l=(n,a)=>{e.innerHTML="",e.className="w-full h-full mt-4";const r=document.createElement("div");r.className="calendar-header flex justify-between items-center py-2 p-2 bg-gray-100";const o=document.createElement("button");o.className="bg-blue-500  text-white",o.innerHTML="&lt;",o.onclick=()=>i(-1);const d=document.createElement("button");d.className="bg-blue-500  text-white",d.innerHTML="&gt;",d.onclick=()=>i(1);const s=document.createElement("div");s.className="text-base text-gray-600",s.innerText=`${a}년 ${n+1}월`,r.appendChild(o),r.appendChild(s),r.appendChild(d);const l=document.createElement("div");l.className="grid grid-cols-7 text-center";["일요일","월요일","화요일","수요일","목요일","금요일","토요일"].forEach((e=>{const t=document.createElement("div");t.className="day-header",t.innerText=e,l.appendChild(t)}));const m=document.createElement("div");m.className="grid grid-cols-7 text-center relative";const u=new Date(a,n,1).getDay(),h=new Date(a,n+1,0).getDate(),g={};for(let e=0;e<u;e++){const e=document.createElement("div");e.className="py-4",m.appendChild(e)}for(let e=1;e<=h;e++){const r=document.createElement("div");r.className="py-6 px-4 border cursor-pointer relative",r.innerHTML=`<div class="text-md absolute top-2 left-2">${e}</div>`;const o=`${a}-${String(n+1).padStart(2,"0")}-${String(e).padStart(2,"0")}`;if(g[o]=r,c[o]){const e=document.createElement("ul");e.className="mt-4 text-left text-md text-gray-800",c[o].forEach(((t,n)=>{const a=document.createElement("li");a.className="border-b py-2 flex justify-between items-center";const c=document.createElement("span");c.innerText=`- ${t}`,a.appendChild(c),e.appendChild(a)})),r.appendChild(e)}e===t.getDate()&&n===t.getMonth()&&a===t.getFullYear()&&r.classList.add("bg-gray-100"),r.onclick=()=>p(e,n,a),m.appendChild(r)}e.appendChild(r),e.appendChild(l),e.appendChild(m)},i=e=>{n+=e,n<0?(n=11,a--):n>11&&(n=0,a++),l(n,a)},p=(e,t,d)=>{const s=`${d}-${String(t+1).padStart(2,"0")}-${String(e).padStart(2,"0")}`,i=c[s]||[],p=document.createElement("div");p.className="task-modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50";const m=document.createElement("div");m.className="bg-white rounded-lg p-6 w-96";const u=document.createElement("div");u.className="flex justify-between items-center mb-4";const h=document.createElement("h3");h.className="text-md font-bold",h.innerText=`${d}-${String(t+1).padStart(2,"0")}-${String(e).padStart(2,"0")} 업무`;const g=document.createElement("i");g.className="fas fa-times cursor-pointer",g.onclick=()=>p.remove(),u.appendChild(h),u.appendChild(g);const f=document.createElement("ul");f.className="task-list mb-4 text-left text-md text-gray-800",i.forEach(((e,t)=>{const r=document.createElement("li");r.className="border-b py-2 flex justify-between items-center";const d=document.createElement("span");d.innerText=e;const i=document.createElement("button");i.className="text-red-500 ml-4 text-2xl font-bold",i.innerText="x",i.dataset.eventId=d.innerText.split(" - ")[2],i.onclick=async()=>{await(async e=>{try{console.log(`Deleting event with ID: ${e}`);const t=await fetch(`/api/deleteEvent/${e}`,{method:"DELETE",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`Failed to delete event: ${t.statusText}`);return(await t.json()).success}catch(e){throw console.error("Error deleting event:",e),e}})(i.dataset.eventId),c[s].splice(t,1),0===c[s].length&&delete c[s],await o(),showToast("select-delete","success",lang),p.remove(),l(n,a)},r.appendChild(d),r.appendChild(i),f.appendChild(r)}));const w=document.createElement("input");w.type="date",w.className="border w-full p-2 mb-4",w.value=`${d}-${String(t+1).padStart(2,"0")}-${String(e).padStart(2,"0")}`;const E=document.createElement("input");E.type="date",E.className="border w-full p-2 mb-4",E.value=`${d}-${String(t+1).padStart(2,"0")}-${String(e).padStart(2,"0")}`;const y=document.createElement("textarea");y.className="border w-full p-2 mb-4",y.style.marginTop="10px",y.placeholder=" 업무 일정 추가",y.rows=5;const b=createSaveButton();b.onclick=()=>{const e=y.value.trim(),t=v.value,d=new Date(w.value),s=new Date(E.value),i=(new Date,generateNanoId());if(e&&t&&d<=s){let m=d;for(;m<=s;){const n=`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,"0")}-${String(m.getDate()).padStart(2,"0")}`;c[n]||(c[n]=[]),c[n].push(`${t} - ${e} - ${i}`),r[n]||(r[n]=[]),r[n].push(`${t} - ${e} - ${i}`),m.setDate(m.getDate()+1)}o(),p.remove(),l(n,a)}};m.appendChild(u),m.appendChild(f),m.appendChild(w),m.appendChild(E);const v=(()=>{const e=document.createElement("select");e.className="w-full";const t=[];for(let e=8;e<24;e++)for(let n=0;n<60;n+=30){const a=`${String(e).padStart(2,"0")}:${String(n).padStart(2,"0")}`;t.push(a)}return t.forEach((t=>{const n=document.createElement("option");n.value=t,n.innerText=t,e.appendChild(n)})),e})();m.appendChild(v),m.appendChild(y),m.appendChild(b),p.appendChild(m),document.body.appendChild(p)};return{init:async()=>{await(async()=>{try{const e=await fetch("/api/calendar"),t=await e.json();console.log(t),c=t||{}}catch(e){console.error("Error fetching tasks:",e)}})(),l(n,a)}}})();window.onload=()=>{calendar.init()};