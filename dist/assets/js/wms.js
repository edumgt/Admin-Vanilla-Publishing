import{createAddButton,createDelButton}from"./common.js";const apiurl="";document.addEventListener("DOMContentLoaded",(async()=>{function e(e){e.innerHTML=""}async function t(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ${e} - Status: ${t.status}`);return await t.json()}catch(e){return console.error("Fetch error:",e),showToast("process-error","error",lang),null}}async function n(e,t){if(t.length>0){const n=t.map((e=>({id:e.id,changes:e})));try{const t=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(t.ok)showToast("well-done","success",lang);else{let e=`Server responded with status: ${t.status}`;if(500===t.status)try{e=(await t.json()).message||"Internal Server Error"}catch(t){e="Internal Server Error (500)"}}const a=await t.json();console.log(a)}catch(e){}}}async function a(e,t){console.log("Sending new row to server:",t);try{const n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`Server responded with status: ${n.status}`);const a=await n.json();console.log("Server response:",a),showToast("input-allowed","success",lang)}catch(e){console.error("Fetch error:",e),showToast("process-error","error",lang)}}async function o(e,t){console.log(t),t.length>0&&await fetch(e,{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),showToast("well-done","success",lang)}const i=document.getElementById("root");i.className="mt-4";const r=[{id:"tab-inbound",name:"입고 관리"},{id:"tab-outbound",name:"출고 관리"},{id:"tab-dashboard",name:"대시보드"}],d=document.createElement("div");d.className="flex border-b",i.appendChild(d);const s={};function c(e,t,i){const r=document.getElementById(e);r.innerHTML=`<div id="${e}-grid"></div>`;const d=new tui.Grid({el:document.getElementById(`${e}-grid`),data:t,bodyHeight:560,pageOptions:{useClient:!0,perPage:15},columns:[{header:"ID",name:"id",width:180,align:"center"},{header:"ISBN",name:"isbn",width:200,align:"center",editor:"text",sortable:!0},{header:"날짜",name:"date",width:150,align:"center",editor:"text",sortable:!0,filter:"text",formatter:({value:e})=>{const t=new Date(e);return isNaN(t.getTime())?"Invalid Date":t.toISOString().split("T")[0]}},{header:"도서명",name:"title",align:"center",editor:"text",sortable:!0,filter:"select"},{header:"수량",name:"quantity",width:80,align:"center",editor:"text",sortable:!0,filter:"number",validation:{required:!0,dataType:"number",min:0},formatter:({value:e})=>e?String(e).replace(/\D/g,""):"0"}],rowHeaders:["checkbox"],copyOptions:{useFormattedValue:!0},editable:!0});let s=!1;tui.Grid.applyTheme("default"),d.on("editingStart",(e=>{if("date"===e.columnName){const t=d.getElement(e.rowKey,e.columnName);if(!t)return;document.querySelectorAll(".custom-datepicker").forEach((e=>e.remove()));const n=document.createElement("div");n.classList.add("custom-datepicker"),n.style.position="absolute",n.style.zIndex="1000",n.style.background="#fff",n.style.border="1px solid #ddd",n.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",n.style.padding="5px",document.body.appendChild(n);const a=t.getBoundingClientRect();n.style.top=`${a.bottom+window.scrollY}px`,n.style.left=`${a.left+window.scrollX}px`;let o=e.value?new Date(e.value):new Date;isNaN(o.getTime())&&(o=new Date),o.setHours(0,0,0,0);const i=new tui.DatePicker(n,{showAlways:!0,date:o,autoClose:!1,type:"date",selectableRanges:[[new Date(1900,0,1),new Date(2100,11,31)]]});let r=i.getDate();i.on("change",(()=>{const t=i.getDate();if(t){if(t.getDate()!==r.getDate()){const a=t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0")+"-"+String(t.getDate()).padStart(2,"0");console.log(`선택한 날짜: ${a}`),setTimeout((()=>{d.finishEditing(),d.setValue(e.rowKey,e.columnName,a),n.remove()}),50)}r=t}})),document.addEventListener("click",(e=>{!n.contains(e.target)&&e.target}),{once:!0})}})),d.on("afterChange",(t=>{if(s)return void(s=!1);console.log("afterChange triggered:",t);const a=t.changes.map((e=>({id:d.getRow(e.rowKey).id,[e.columnName]:e.value})));n("tab-inbound-section"===e?"/api/inbound/update":"/api/outbound/update",a),setTimeout((()=>{t.changes.forEach((e=>{"date"===e.columnName&&(console.log(`afterChange 적용됨: ${e.value}`),d.setValue(e.rowKey,e.columnName,e.value))}))}),100)})),d.on("editingFinish",(e=>{if("quantity"===e.columnName){let t=String(e.value),n=t.replace(/\D/g,"");console.log("newValue: "+n),t!==n?(showToast("number-only","warning",lang),s=!0):s=!1,""===n&&(n="0"),d.setValue(e.rowKey,e.columnName,Number(n))}if("date"===e.columnName){let t=String(e.value);/^\d{4}-\d{2}-\d{2}$/.test(t)?s=!1:(showToast("invalid-date-format","warning",lang),s=!0,d.setValue(e.rowKey,e.columnName,""))}}));const c=createAddButton();c.addEventListener("click",(()=>{const t={id:generateNanoId(),date:(new Date).toISOString().split("T")[0],title:"",quantity:0,isbn:""};d.prependRow(t),a("tab-inbound-section"===e?"/api/inbound/add":"/api/outbound/add",t)}));const l=createDelButton();l.addEventListener("click",(()=>{const t=d.getCheckedRows();0!==t.length?(d.removeCheckedRows(),o("tab-inbound-section"===e?"/api/inbound/delete":"/api/outbound/delete",t)):showToast("delete-not","warning",lang)})),r.appendChild(c),r.appendChild(l)}function l(e,t){t?c(e.id,t):e.innerHTML='<div class="text-center text-lg font-semibold">데이터를 불러오는데 실패했습니다.</div>'}function u(e,t){t?c(e.id,t):e.innerHTML='<div class="text-center text-lg font-semibold">데이터를 불러오는데 실패했습니다.</div>'}function m(e){e.innerHTML='<div id="stock-chart" class="w-full border border-gray-300 rounded-lg p-2 "></div>\n            <div id="monthly-outbound-chart" class="w-full border border-gray-300 rounded-lg p-2  mt-4"></div>';Object.fromEntries(g.map((e=>[e.isbn,e.quantity])));const t=Object.fromEntries(h.map((e=>[e.isbn,e.quantity]))),n=[];g.forEach((e=>{const a=e.quantity-(t[e.isbn]||0);0!==a&&n.push({title:e.title,quantity:a})}));const a=n.map((e=>e.title)),o=n.map((e=>e.quantity));if(n.length>0){const e={chart:{type:"pie",height:350},series:o,labels:a,title:{text:"재고 차이가 있는 도서 목록",align:"center"}};new ApexCharts(document.querySelector("#stock-chart"),e).render()}else document.querySelector("#stock-chart").innerHTML='<div class="text-center text-lg font-semibold">모든 재고가 일치합니다</div>';const i=Array.from({length:12},((e,t)=>({month:`${t+1}월`,quantity:Math.floor(500*Math.random())+50}))),r={chart:{type:"line",height:300},series:[{name:"월별 출고량",data:i.map((e=>e.quantity))}],xaxis:{categories:i.map((e=>e.month))},title:{text:"2024년 월별 출고 추이",align:"center"}};new ApexCharts(document.querySelector("#monthly-outbound-chart"),r).render()}r.forEach((e=>{const t=document.createElement("button");t.id=e.id,t.className="flex-1 text-center text-gray-600 hover:bg-gray-100",t.innerText=e.name,d.appendChild(t);const n=document.createElement("div");n.id=`${e.id}-section`,n.className="py-2 hidden",i.appendChild(n),s[e.id]=n})),s["tab-inbound"].classList.remove("hidden"),document.getElementById("tab-inbound").classList.add("active-tab"),document.querySelectorAll("button").forEach((n=>{n.addEventListener("click",(async()=>{r.forEach((e=>{s[e.id].classList.add("hidden"),document.getElementById(e.id).classList.remove("active-tab")}));const a=s[n.id];document.getElementById(n.id).classList.add("active-tab"),function(e){e.innerHTML='<div class="text-center text-lg font-semibold mt-4">데이터를 불러오는 중...</div>'}(a),setTimeout((async()=>{let o,i;"tab-inbound"===n.id?(o=await t("/api/inbound"),e(a),l(a,o)):"tab-outbound"===n.id?(i=await t("/api/outbound"),e(a),u(a,i)):"tab-dashboard"===n.id&&(o=await t("/api/inbound"),i=await t("/api/outbound"),e(a),m(a)),a.classList.remove("hidden")}),300)}))}));const g=await t("/api/inbound"),h=await t("/api/outbound");l(s["tab-inbound"],g),u(s["tab-outbound"],h),m(s["tab-dashboard"])}));