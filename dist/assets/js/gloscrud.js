import{createAddButton,createDelButton,createSaveButton,createSearchButton,createResetSearchButton,createTanslations,createBadgeRenderer,createSaveRenderer}from"./common.js";let rowsPerPage=1e3,gridBodyHeight=630;const options={year:"numeric",month:"2-digit",day:"2-digit"},currentDate=(new Date).toLocaleDateString("ko-KR",options).replace(/[\.]/g,"-").replace(/[\s]/g,"").substring(0,10);function loadPageData(e,t){const o=(e-1)*t,n=o+t;return loadData().slice(o,n)}function updateDataCount(){const e=loadData();document.getElementById("dataCount").textContent=`Total : ${e.length}`}function loadData(){const e=localStorage.getItem("glosCrudData");return e?JSON.parse(e):[]}function saveData(e){}fetch("/api/glos").then((e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()})).then((e=>{loadData(e),localStorage.setItem("glosCrudData",JSON.stringify(e))})).catch((e=>{showToast("loading-error","error",lang);const t=localStorage.getItem("glosCrudData");t?loadData(JSON.parse(t)):console.log("No data available in local storage")}));const BadgeRenderer=createBadgeRenderer,SaveRenderer=createSaveRenderer,grid=new tui.Grid({el:document.getElementById("grid"),rowHeaders:["rowNum","checkbox"],editingEvent:"click",scrollX:!0,scrollY:!0,bodyHeight:gridBodyHeight,pageOptions:{useClient:!0,perPage:rowsPerPage},rowHeight:42,minRowHeight:42,columns:[{header:"Key",name:"id",width:250,align:"left",sortable:!0,resizable:!0,width:100,minWidth:80},{header:"영문단어",name:"en",editor:"text",validation:{required:!0},sortable:!0,filter:"text",resizable:!0,width:150},{header:"한글",name:"ko",editor:"text",sortable:!0,filter:"text",resizable:!0,width:200},{header:"설명",name:"desc",editor:"text",sortable:!0,filter:"text",resizable:!0},{header:"Image",name:"img",editor:"text",sortable:!0,filter:"text",resizable:!0,width:200},{header:"CreateDT",name:"createdAt",width:150,align:"center",sortable:!0},{header:"상세",name:"view",align:"center",text:"V",renderer:{type:BadgeRenderer},width:60,resizable:!1},{header:"수정",name:"save",align:"center",width:60,resizable:!1,renderer:{type:SaveRenderer}}],data:loadPageData(1,rowsPerPage),columnOptions:{frozenCount:2,frozenBorderWidth:2}});updateDataCount();const deleteButton=createDelButton();deleteButton.addEventListener("click",(function(){if(grid.getCheckedRowKeys().length>0){const e=grid.getCheckedRows().map((e=>e.id)).filter((e=>!!e));grid.removeCheckedRows(),fetch("/api/glos/delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:e})}).then((e=>e.json())).then((e=>{e.success&&grid.removeCheckedRows()})).catch((e=>{console.error("삭제 API 오류:",e)})),showToast("select-delete","success",lang),updateDataCount(),syncLocalStorageWithServer()}else showToast("delete-not","warning",lang)}));const saveButton=createSaveButton();saveButton.addEventListener("click",(()=>{const e=grid.getData().filter((e=>!e.id));Promise.all(e.map((e=>fetch("/api/setGlos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({en:e.en,ko:e.ko,desc:e.desc,img:e.img})}).then((e=>e.json())).then((t=>{t.success?(console.log(t.id),e.id=t.id):console.error("INSERT 실패:",t.message)}))))).then((()=>{showToast("well-done","success",lang),syncLocalStorageWithServer()})).catch((e=>{console.error("신규 저장 중 오류:",e),showToast("process-error","warning",lang)}))}));const addButton=createAddButton();addButton.addEventListener("click",(function(){if(grid.getData().some((e=>""===e.tpCd||""===e.tpNm)))return void showToast("input-allowed","info",lang);grid.prependRow({en:"",ko:"",desc:""},{focus:!0}),updateDataCount()}));const searchButton=createSearchButton();btnContainer.appendChild(searchButton),btnContainer.appendChild(addButton),btnContainer.appendChild(deleteButton),btnContainer.appendChild(saveButton);const resetSearchButton=createResetSearchButton();function initNew(){grid.prependRow({en:"",ko:"",desc:""},{focus:!0}),updateDataCount()}resetSearchButton.classList.add("ml-2"),btnContainer.appendChild(resetSearchButton),grid.on("click",(e=>{const{columnName:t,rowKey:o}=e;if("view"===t){toggleModal(!0,grid.getRow(o),o)}if("Key"===e.columnName&&showToast("auto-key","info",lang),"save"===t){saveRowEdit(grid.getRow(o))}})),grid.on("editingStart",(e=>{})),grid.on("editingFinish",(e=>{})),initNew(),new Pikaday({field:document.getElementById("datePicker"),format:"YYYY-MM-DD",toString(e,t){const o=e.getDate(),n=e.getMonth()+1;return`${e.getFullYear()}-${n<10?"0":""}${n}-${o<10?"0":""}${o}`}}),document.getElementById("saveModal").addEventListener("click",(()=>{const e=document.getElementById("modalForm"),t=new FormData(e),o={};for(const[e,n]of t.entries())o[e]=n;null!==currentRowKey&&(grid.setValue(currentRowKey,"id",o.id),grid.setValue(currentRowKey,"en",o.en),grid.setValue(currentRowKey,"ko",o.ko),grid.setValue(currentRowKey,"desc",o.desc)),toggleModal(!1),showToast("well-done","success",lang)}));let currentRowKey=null;function toggleModal(e,t={},o=null){const n=document.getElementById("modal"),a=document.getElementById("modalForm");if(currentRowKey=o,e){a.innerHTML="";for(const[e,o]of Object.entries(t)){if(e.startsWith("_"))continue;if(e.startsWith("view"))continue;if(e.startsWith("save"))continue;if(e.startsWith("created"))continue;if(e.startsWith("sort"))continue;if(e.startsWith("unique"))continue;if(e.startsWith("row"))continue;const t=document.createElement("div");t.className="flex flex-col";const n=document.createElement("label");n.className="text-sm text-gray-700",n.textContent=e;const r=document.createElement("input");if(r.type="text",r.className="border rounded px-3 py-2 mt-1 text-gray-900",r.name=e,r.value=o||"",t.appendChild(n),t.appendChild(r),"img"===e){const e=document.createElement("img");e.style.width="300px",e.style.height="auto",e.style.marginTop="0.5rem",e.src=o||"",t.appendChild(e)}a.appendChild(t)}const e=document.createElement("h3");e.textContent="정정요청 목록",e.className="text-lg font-bold mt-4",a.appendChild(e);const o=document.createElement("div");o.id="correctionGridContainer",o.style.height="200px",o.style.marginTop="0.5rem",a.appendChild(o),t.id?fetch(`/api/getGlosReq?glos_id=${t.id}`).then((e=>e.json())).then((e=>{new tui.Grid({el:o,data:e,scrollX:!1,scrollY:!0,rowHeight:32,bodyHeight:160,columns:[{header:"ID",name:"id",width:50},{header:"요청내용",name:"req_msg",width:250},{header:"요청일자",name:"req_date",width:120}]})})).catch((e=>{console.error("정정요청 로드 실패:",e)})):o.innerHTML="<p class='text-sm text-gray-500'>신규 데이터이므로 정정요청이 없습니다.</p>",n.classList.remove("hidden")}else n.classList.add("hidden")}searchButton.addEventListener("click",(function(){const e=loadData(),t=document.getElementById("en").value.toLowerCase().trim(),o=document.getElementById("ko").value.toLowerCase().trim(),n=document.getElementById("desc").value.toLowerCase().trim(),a=(document.getElementById("datePicker").value,e.filter((e=>{const a=!t||(e.en||"").toLowerCase().includes(t),r=!o||(e.ko||"").toLowerCase().includes(o),s=!n||(e.desc||"").toLowerCase().includes(n);return a&&r&&s})));grid.resetData(a),saveButton.disabled=!0,saveButton.classList.add("bg-gray-400","cursor-not-allowed"),saveButton.classList.remove("bg-gray-700","hover:bg-gray-600"),addButton.disabled=!0,addButton.classList.add("bg-gray-400","cursor-not-allowed"),addButton.classList.remove("bg-gray-700","hover:bg-gray-600"),showToast("search-click","info",lang)})),resetSearchButton.addEventListener("click",(function(){const e=loadData();document.getElementById("en").value="",document.getElementById("ko").value="",document.getElementById("desc").value="",document.getElementById("datePicker").value="",grid.resetData(e),saveButton.disabled=!1,saveButton.classList.remove("bg-gray-400","cursor-not-allowed"),saveButton.classList.add("bg-gray-700","hover:bg-gray-600"),addButton.disabled=!1,addButton.classList.remove("bg-gray-400","cursor-not-allowed"),addButton.classList.add("bg-gray-700","hover:bg-gray-600"),showToast("new-save","info",lang)}));const rows=document.querySelectorAll(".tui-grid-rside-area .tui-grid-body-tbody tr");if(rows.length>0){const e=rows[rows.length-1];e.style.backgroundColor="#fff",e.style.borderBottom="1px solid #8f8f8f"}function saveRowEdit(e){fetch("/api/glos/"+e.id,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({en:e.en,ko:e.ko,desc:e.desc,img:e.img})}).then((e=>e.json())).then((e=>{e.success?showToast("well-done","success",lang):showToast("process-error","warning",lang)})).catch((e=>{console.error("업데이트 에러:",e),showToast("process-error","warning",lang)}))}function syncLocalStorageWithServer(){fetch("/api/glos").then((e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()})).then((e=>{localStorage.setItem("glosCrudData",JSON.stringify(e)),grid.resetData(e),updateDataCount(e.length)})).catch((e=>{console.error("서버 전체 조회 실패:",e)}))}