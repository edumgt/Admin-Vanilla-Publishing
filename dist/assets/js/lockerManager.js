export default class LockerManager{constructor(e={}){this.container=document.getElementById(e.containerId||"lockerContainer"),this.rows=e.rows||5,this.cols=e.cols||10,this.lockers=[],this.statuses=["사용중","사용가능","일시중지","수리중"],this.users=["홍길동","김영희","이철수","박지영","최수민","오민준"],this.loadLockers()}loadLockers(){fakeFetch("/api/lockers").then((e=>e.json())).then((e=>{this.lockers=e,this.renderLockers()})).catch((e=>console.error(e)))}updateLockerData(e){return fakeFetch("/api/lockers",{method:"PUT",body:JSON.stringify(e)}).then((e=>e.json()))}handleLockerClick(e){"사용가능"===e.status?this.showAssignmentModal(e):this.toggleLocker(e.id)}toggleLocker(e){const t=this.lockers.find((t=>t.id===e));if(t){const e=(this.statuses.indexOf(t.status)+1)%this.statuses.length;t.status=this.statuses[e],"사용중"!==t.status&&delete t.assignedUser,this.updateLockerData(t).then((e=>{Object.assign(t,e),this.updateLockerElement(t)})).catch((e=>console.error(e)))}}getStatusBadgeClasses(e){switch(e){case"사용중":return"bg-red-200 text-red-800";case"사용가능":return"bg-green-200 text-green-800";case"일시중지":return"bg-yellow-200 text-yellow-800";case"수리중":return"bg-gray-200 text-gray-800";default:return""}}updateLockerElement(e){const t=document.querySelector(`.locker[data-id='${e.id}']`);if(t){const s=t.querySelector(".status-text");s&&("사용중"===e.status&&e.assignedUser?s.textContent=`${e.assignedUser} ${e.status}`:s.textContent=e.status,s.className=`status-text inline-block px-2 py-1 rounded-full text-xs font-semibold ${this.getStatusBadgeClasses(e.status)}`)}}showUsageHistory(e){const t=document.getElementById("usageHistoryModal"),s=document.getElementById("usageGrid");s.innerHTML="";const o=e.usageHistory;new tui.Grid({el:s,data:o,columns:[{header:"사용 날짜",name:"date"},{header:"사용자명",name:"username"},{header:"비고",name:"remarks"}],bodyHeight:300}),t.classList.remove("hidden")}showAssignmentModal(e){const t=document.getElementById("assignmentModal"),s=document.getElementById("userSearchInput"),o=document.getElementById("userSearchResults");s.value="",o.innerHTML="",t.dataset.lockerId=e.id,this.renderUserSearchResults(this.users),t.classList.remove("hidden")}renderUserSearchResults(e){const t=document.getElementById("userSearchResults");if(t.innerHTML="",0===e.length)return void(t.textContent="검색된 사용자가 없습니다.");const s=document.createElement("ul");s.className="divide-y divide-gray-200",e.forEach((e=>{const t=document.createElement("li");t.className="p-2 cursor-pointer hover:bg-gray-100",t.textContent=e,t.addEventListener("click",(()=>{this.assignUserToLocker(parseInt(document.getElementById("assignmentModal").dataset.lockerId),e)})),s.appendChild(t)})),t.appendChild(s)}assignUserToLocker(e,t){const s=this.lockers.find((t=>t.id===e));if(s){s.status="사용중",s.assignedUser=t;const e=new Date,o=`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")}`;s.usageHistory.push({date:o,username:t,remarks:"배정됨"}),this.updateLockerData(s).then((e=>{Object.assign(s,e),this.updateLockerElement(s)})).catch((e=>console.error(e)))}document.getElementById("assignmentModal").classList.add("hidden")}renderLockers(){if(!this.container)return;this.container.innerHTML="";const e=document.createElement("div");e.className="grid gap-4",e.style.gridTemplateColumns=`repeat(${this.cols}, minmax(0, 1fr))`,this.lockers.forEach((t=>{const s=document.createElement("div");s.className="locker relative p-6 border border-gray-300 rounded-lg cursor-pointer transition-colors duration-300 bg-white shadow-sm",s.dataset.id=t.id;const o=document.createElement("h5");o.textContent=`Locker ${t.id}`,o.className="text-md border-b pb-2 mb-2";const r=document.createElement("span");r.className=`status-text inline-block px-2 py-1 rounded-full text-xs font-semibold ${this.getStatusBadgeClasses(t.status)}`,r.textContent="사용중"===t.status&&t.assignedUser?`${t.assignedUser} ${t.status}`:t.status;const n=document.createElement("button");n.textContent="사용이력",n.className="absolute top-2 right-2 bg-blue-500 text-white text-xs px-2 py-1 rounded",n.addEventListener("click",(e=>{e.stopPropagation(),this.showUsageHistory(t)})),s.addEventListener("click",(()=>{this.handleLockerClick(t)})),s.appendChild(o),s.appendChild(r),s.appendChild(n),e.appendChild(s)})),this.container.appendChild(e)}}class LockerAPI{static getLockers(){return new Promise(((e,t)=>{const s=localStorage.getItem("lockersData");if(s)e(JSON.parse(s));else{const t=[],s=["사용중","사용가능","일시중지","수리중"];for(let e=0;e<50;e++){const o=s[Math.floor(Math.random()*s.length)];t.push({id:e+1,status:o,usageHistory:[],assignedUser:"사용중"===o?"홍길동":null})}localStorage.setItem("lockersData",JSON.stringify(t)),e(t)}}))}static updateLocker(e){return new Promise(((t,s)=>{const o=localStorage.getItem("lockersData");let r=[];o&&(r=JSON.parse(o));const n=r.findIndex((t=>t.id===e.id));-1!==n?(r[n]=e,localStorage.setItem("lockersData",JSON.stringify(r)),t(e)):s("Locker not found")}))}static createLocker(e){return new Promise(((t,s)=>{const o=localStorage.getItem("lockersData");let r=[];o&&(r=JSON.parse(o)),r.push(e),localStorage.setItem("lockersData",JSON.stringify(r)),t(e)}))}static deleteLocker(e){return new Promise(((t,s)=>{const o=localStorage.getItem("lockersData");let r=[];o&&(r=JSON.parse(o)),r=r.filter((t=>t.id!==e)),localStorage.setItem("lockersData",JSON.stringify(r)),t(!0)}))}}class FakeResponse{constructor(e){this._body=e}json(){return Promise.resolve(JSON.parse(this._body))}}function fakeFetch(e,t={}){return new Promise(((s,o)=>{setTimeout((()=>{if("/api/lockers"===e)if(t.method&&"GET"!==t.method)if("PUT"===t.method){const e=JSON.parse(t.body);LockerAPI.updateLocker(e).then((e=>{s(new FakeResponse(JSON.stringify(e)))}))}else if("POST"===t.method){const e=JSON.parse(t.body);LockerAPI.createLocker(e).then((e=>{s(new FakeResponse(JSON.stringify(e)))}))}else if("DELETE"===t.method){const e=JSON.parse(t.body).id;LockerAPI.deleteLocker(e).then((e=>{s(new FakeResponse(JSON.stringify(e)))}))}else o("Method not supported");else fetch("/api/lockers").then((e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()})).then((e=>{s(new FakeResponse(JSON.stringify(e))),console.log(JSON.stringify(e))})).catch((e=>{showToast("loading-error","error",lang),console.log(e)}));else o("Unknown endpoint")}),300)}))}