<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>TUI Grid DB Admin</title>
  <link href="assets/css/default.css" rel="stylesheet">
  <script src="https://uicdn.toast.com/tui-grid/latest/tui-grid.js"></script>
</head>
<body>
  <div class="px-4 py-2">
    <div class="flex gap-4 py-4">
      <label>Host:
        <input type="text" id="host" value="edumgtmssql2019.cg0ugoglztrn.ap-northeast-2.rds.amazonaws.com">
      </label>
      <label>User:
        <input type="text" id="user" value="edumgt">
      </label>
      <label>Password:
        <input type="text" id="password" value="edumgt2250!">
      </label>
      <label>Database:
        <input type="text" id="database" value="kegtest">
      </label>
      <input type="button" id="btnConnect" class="history-button" value="CONNECT">
    </div>
    <div class="flex gap-4 py-4">
      <label>Query:</label>
      <textarea id="query" rows="1"
        style="width:800px">SELECT * FROM kegtest.dbo.T_code where groupcode like 'BD%'</textarea>
      <input type="button" id="btnQuery" class="history-button" value="RUN">
    </div>
    <div id="myGrid" style="width: 100%; height: 320px;"></div>
  </div>
  <script>
    const grid = new tui.Grid({
      el: document.getElementById('myGrid'),
      data: [],
      columns: [],
      scrollX: false,
      scrollY: true
    });

    const hostInput = document.getElementById('host');
    const userInput = document.getElementById('user');
    const passwordInput = document.getElementById('password');
    const dbInput = document.getElementById('database');
    const queryInput = document.getElementById('query');
    const btnConnect = document.getElementById('btnConnect');
    const btnQuery = document.getElementById('btnQuery');
    btnConnect.addEventListener('click', async () => {
      const payload = {
        host: hostInput.value,
        user: userInput.value,
        password: passwordInput.value,
        database: dbInput.value
      };

      try {
        const response = await fetch('/db/dynamicConnect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const result = await response.json();
        if (result.success) {
          alert('DB Connection Succeeded!\n' + JSON.stringify(result.data));
        } else {
          alert('DB Connection Failed:\n' + result.message + '\n' + result.error);
        }
      } catch (err) {
        alert('Fetch Error: ' + err.message);
      }
    });

    btnQuery.addEventListener('click', async () => {
      const payload = { query: queryInput.value };

      try {
        const response = await fetch('/db/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const result = await response.json();
        if (result.success) {
          const rows = result.data;
          const columns = createDynamicColumns(rows);
          grid.setColumns(columns);
          grid.resetData(rows); 
        } else {
          alert('Query Failed:\n' + result.message + '\n' + result.error);
        }
      } catch (err) {
        alert('Fetch Error: ' + err.message);
      }
    });
    function createDynamicColumns(rows) {
      if (!Array.isArray(rows) || rows.length === 0) {
        return [];
      }
      const keys = Object.keys(rows[0]);
      return keys.map(key => ({
        header: key,
        name: key
      }));
    }
  </script>
</body>
</html>